/*! Fabrik */

define(["jquery","fab/fabrik"],(function(t,e){return new Class({pluginTotal:0,topTotal:-1,initialize:function(t,e,n){"string"===typeOf(t)&&(t=[t]),this.id=e,this.plugins=t,this.type=n,window.addEvent("domready",function(){var e;for(this.accordion=new Fx.Accordion([],[],{alwaysHide:!0,display:-1,duration:"short"}),e=0;e<t.length;e++)this.addTop(t[e]);this.periodical=this.iniAccordion.periodical(250,this),this.watchPluginSelect(),this.watchDelete(),this.watchAdd();var n=document.id("plugins");"null"!==typeOf(n)&&(n.addEvent("click:relay(h3.title)",(function(t,e){document.id("plugins").getElements("h3.title").each((function(t){t!==e&&t.removeClass("pane-toggler-down")})),e.toggleClass("pane-toggler-down")})),this.watchDescriptions(n))}.bind(this))},watchDescriptions:function(t){t.addEvent("keyup:relay(input[name*=plugin_description])",(function(t,e){var n=e.getParent(".actionContainer"),i=n.getElement(".pluginTitle"),a=n.getElement("select[name*=plugin]").getValue(),o=e.getValue();i.set("text",a+": "+o)}))},iniAccordion:function(){this.pluginTotal===this.plugins.length&&(1===this.plugins.length?this.accordion.display(0):this.accordion.display(-1),clearInterval(this.periodical))},canSaveForm:function(){return"complete"===document.readyState&&e.requestQueue.empty()},watchDelete:function(){document.id("adminForm").addEvent("click:relay(a.removeButton, a[data-button=removeButton])",function(t,e){t.preventDefault(),this.pluginTotal--,this.topTotal--,this.deletePlugin(t)}.bind(this))},watchAdd:function(){var t=document.id("addPlugin");"null"!==typeOf(t)&&t.addEvent("click",function(t){t.stop(),this.accordion.display(-1),this.addTop()}.bind(this))},addTop:function(t){var n,i,a,o,l,d,r;"string"===typeOf(t)?(n=1,i=!1,l=!1,d=!0,t=t||"",a="",o="",r=!0):(n=t?t.published:1,i=t?t.show_icon:1,l=t?t.must_validate:0,d=t?t.validate_hidden:1,a=t?t.validate_in:"both",o=t?t.validation_on:"both",r=t?t.new_repetible_line:1,t=t?t.plugin:"");var c=new Element("div.actionContainer.panel.accordion-group"),u=new Element("a.accordion-toggle",{href:"#"});u.adopt(new Element("span.pluginTitle").set("text",""!==t?t+" "+Joomla.JText._("COM_FABRIK_LOADING").toLowerCase():Joomla.JText._("COM_FABRIK_LOADING")));var s=new Element("div.title.pane-toggler.accordion-heading").adopt(new Element("strong").adopt(u)),p=new Element("div.accordion-body");c.adopt(s),c.adopt(p),c.inject(document.id("plugins")),this.accordion.addSection(s,p);var g=this.topTotal+1,m={option:"com_fabrik",view:"plugin",task:"top",format:"raw",type:this.type,plugin:t,plugin_published:n,show_icon:i,must_validate:l,validate_hidden:d,validate_in:a,validation_on:o,c:this.topTotal,id:this.id,new_repetible_line:r},h=new Request.HTML({url:"index.php",data:m,update:p,onRequest:function(){e.debug&&fconsole("Fabrik pluginmanager: Adding",this.type,"entry",g.toString())}.bind(this),onSuccess:function(e){""!==t?this.addPlugin(t,g):s.getElement("span.pluginTitle").set("text",Joomla.JText._("COM_FABRIK_PLEASE_SELECT")),this.updateBootStrap(),FabrikAdmin.reTip()}.bind(this),onFailure:function(t){fconsole("Fabrik pluginmanager addTop ajax failed:",t)},onException:function(t,e){fconsole("Fabrik pluginmanager addTop ajax exception:",t,e)}});this.topTotal++,e.requestQueue.add(h)},updateBootStrap:function(){document.getElements(".radio.btn-group label").addClass("btn"),document.getElements(".btn-group input[checked=checked]").each((function(e){""===e.get("value")?document.getElement("label[for="+e.get("id")+"]").addClass("active btn-primary"):"0"===e.get("value")?document.getElement("label[for="+e.get("id")+"]").addClass("active btn-danger"):document.getElement("label[for="+e.get("id")+"]").addClass("active btn-success"),void 0!==t&&t("*[rel=tooltip]").tooltip()})),document.getElements(".hasTip").each((function(t){var e=t.get("title");if(e){var n=e.split("::",2);t.store("tip:title",n[0]),t.store("tip:text",n[1])}}));new Tips($$(".hasTip"),{maxTitleChars:50,fixed:!1})},watchPluginSelect:function(){document.id("adminForm").addEvent("change:relay(select.elementtype)",function(t,e){t.preventDefault();var n=e.get("value"),i=e.getParent(".pluginContainer"),a=""!==n?n+" "+Joomla.JText._("COM_FABRIK_LOADING").toLowerCase():Joomla.JText._("COM_FABRIK_PLEASE_SELECT");e.getParent(".actionContainer").getElement("span.pluginTitle").set("text",a);var o=i.id.replace("formAction_","").toInt();this.addPlugin(n,o)}.bind(this))},addPlugin:function(t,n){if(n="number"===typeOf(n)?n:this.pluginTotal,""!==t){var i=new Request.HTML({url:"index.php",data:{option:"com_fabrik",view:"plugin",format:"raw",type:this.type,plugin:t,c:n,id:this.id},update:document.id("plugins").getElements(".actionContainer")[n].getElement(".pluginOpts"),onRequest:function(){e.debug&&fconsole("Fabrik pluginmanager: Loading",this.type,"type",t,"for entry",n.toString())}.bind(this),onSuccess:function(){var e=document.id("plugins").getElements(".actionContainer")[n],i=e.getElement("span.pluginTitle"),a=t,o=e.getElement("input[name*=plugin_description]");o&&(a+=": "+o.getValue()),i.set("text",a),this.pluginTotal++,this.updateBootStrap(),FabrikAdmin.reTip()}.bind(this),onFailure:function(t){fconsole("Fabrik pluginmanager addPlugin ajax failed:",t)},onException:function(t,e){fconsole("Fabrik pluginmanager addPlugin ajax exception:",t,e)}});e.requestQueue.add(i)}else document.id("plugins").getElements(".actionContainer")[n].getElement(".pluginOpts").empty()},deletePlugin:function(t){var n=t.target.getParent("fieldset.pluginContainer");if("null"!==typeOf(n)){if(e.debug&&fconsole("Fabrik pluginmanager: Deleting",this.type,"entry",n.id,"and renaming later entries"),n.id.match(/_\d+$/)){var i=n.id.match(/_(\d+)$/)[1].toInt();document.id("plugins").getElements("input, select, textarea, label, fieldset").each((function(t){var e=t.name?t.name.match(/\[(\d+)\]/):null;if(!e&&t.id&&(e=t.id.match(/-(\d+)/)),!e&&"label"===t.get("tag").toLowerCase()&&t.get("for")&&(e=t.get("for").match(/-(\d+)/)),e){var n=e[1].toInt();n>i&&(n--,t.name&&(t.name=t.name.replace(/(\[)(\d+)(\])/,"["+n+"]")),t.id&&(t.id=t.id.replace(/(-)(\d+)/,"-"+n)),"label"===t.get("tag").toLowerCase()&&t.get("for")&&t.set("for",t.get("for").replace(/(-)(\d+)/,"-"+n)))}})),document.id("plugins").getElements("fieldset.pluginContainer").each((function(t){if(t.id.match(/formAction_\d+$/)){var e=t.id.match(/formAction_(\d+)$/)[1].toInt();e>i&&(e-=1,t.id=t.id.replace(/(formAction_)(\d+)$/,"$1"+e))}}))}t.stop(),t.target.getParent(".actionContainer").dispose()}}})}));