/**
 * Treeview filter
 *
 * @copyright: Copyright (C) 2019-2020  Projeto PITT. - All rights reserved.
 * @license:   GNU/GPL http://www.gnu.org/copyleft/gpl.html
 */
define(["jquery","lib/tree.jquery"],(function(e){return new Class({Implements:[Options,Events],options:{typeFilter:""},initialize:function(t,n,o,i){var a=this;this.setOptions(i),this.options.dataTree=[],this.options.labeldivTree=o,this.options.labeldivSelected=document.getElement(n);var r=e(this.options.labeldivTree+"_popupformbtn");r[0]&&r[0].addEventListener("click",(function(){var e=window.location.origin+window.location.pathname+"?option=com_fabrik&view=form&tmpl=component&ajax=1&formid="+a.options.popUpId+"&noredirect=1";window.open(e,"","top=300,width=800,height=600")}));var l=e(this.options.labeldivTree+"_refreshbutton");l[0]&&l[0].addEventListener("click",(function(){e(a.options.labeldivTree).tree("getTree").iterate((function(t){t.hasChildren()&&e(a.options.labeldivTree).tree("closeNode",t,!0)})),this.ajax=new Request({url:a.options.url+"&method=treeview_options",data:{value:""},onSuccess:function(t){let n=a.buildResultTree(JSON.parse(t));e(a.options.labeldivTree).tree("loadData",n),a.addEventsTreeAfterRefreshBtn()}.bind(this),onFailure:function(e){this.ajax=null,fconsole("PITT treeview autocomplete: Ajax failure: Code "+e.status+": "+e.statusText)}.bind(this)}).send()})),this.buildTreeRecursive()},buildEventTreeRecursive:function(){var t=this;e(t.options.labeldivTree).on("tree.open",(function(n){let o=[],i=parseInt(n.node.value);JSON.parse(t.options.count).forEach((e=>{e.children||(e.children=[{}]),parseInt(e.parent)==i&&o.push(e)})),e(t.options.labeldivTree).tree("loadData",o,n.node)})),e(t.options.labeldivTree).on("tree.click",(function(e){var n=e.node;t.existsTag(n.value)||t.addTag(n.name,n.value,!0)}))},addEventsTreeAfterRefreshBtn:function(){let t=this;e(t.options.labeldivTree).on("tree.open",(function(n){let o=parseInt(n.node.value)?parseInt(n.node.value):parseInt(n.node.id);"datetree"==t.options.typeFilter&&(o=n.node.name),o?this.ajax=new Request({url:t.options.url+"&method=treeview_options",data:{value:o},onSuccess:function(o){e(t.options.labeldivTree).tree("loadData",JSON.parse(o),n.node)}.bind(this),onFailure:function(e){this.ajax=null,fconsole("Fabrik autocomplete: Ajax failure: Code "+e.status+": "+e.statusText),n.node.children=[]}.bind(this)}).send():(fconsole("Fabrik autocomplete: Ajax failure: Code "+xhr.status+": "+xhr.statusText),n.node.children=!1)})),e(t.options.labeldivTree).on("tree.click",(function(e){var n=e.node,o=n.value?n.value:n.id;t.existsTag(o)||t.addTag(n.name,o,!0)}));var n=e(this.options.labeldivTree+"_popupformbtn");n[0]&&n[0].addEventListener("click",(function(){var e=window.location.origin+window.location.pathname+"?option=com_fabrik&view=form&tmpl=component&ajax=1&formid="+t.options.popUpId+"&noredirect=1";window.open(e,"","top=300,width=800,height=600")})),e(this.options.labeldivTree+"_refreshbutton")[0]&&e(t.options.labeldivTree).on("tree.contextmenu",(function(e){var n=e.node;window.open(window.location.pathname+"?option=com_fabrik&view=form&tmpl=component&formid="+t.options.popUpId+"&rowid="+n.id,"","top=300,width=800,height=600")}))},buildTreeRecursive:function(){var t=this,n=[];function o(e){return 7==e||8==e}JSON.parse(t.options.count).forEach((e=>{t.options.rootCategory?t.options.rootCategory==e.value||t.options.rootCategory==e.id?(e.children=[],t.options.dataTree.push(e)):n.push(e):e.parent&&"0"!=e.parent||(e.children||(e.children=[{}]),t.options.dataTree.push(e))})),0!=n.length&&(t.options.dataTree[0].children=n),t.options.dataTree=1==t.options.sortedBy?t.options.dataTree.sort(t.compareValues("counter","desc")):t.options.dataTree.sort(t.compareValues("counter","asc")),e(this.options.labeldivTree).tree({data:t.options.dataTree,selectable:!1,dragAndDrop:!0,onDragStop:function(n,i){var a,r;if(t.options.dragndropProp){if(1==t.options.dragndropProp)if(t.options.userGroups.find(o)){if(a=document.elementFromPoint(i.clientX,i.clientY))if((r=a.closest("a"))&&r.getAttribute("data-rowid")){var l=r.getAttribute("data-rowid"),s=n.value?n.value:n.id;e.ajax({url:t.options.url+"&method=formrow_options",data:{value:parseInt(l)}}).done((function(n){n?e.ajax({type:"POST",url:"index.php?option=com_fabrik&view=form&Itemid=135&formid="+t.options.listId+"&rowid="+l+"&listid="+t.options.listId,context:document.body}).done((function(o){var i=e(o).find(".fabrikForm");i[0]?e.ajax({url:t.options.url+"&method=fileuploadelements_options",data:{value:parseInt(l)}}).done((function(t){JSON.parse(t).forEach((e=>{i[0].getElementById(e.name)&&(i[0].getElementById(e.name).getParent().appendChild(new Element("input",{type:"hidden",name:e.name+"[id]["+e.strImg+"]",value:e.value})),i[0].getElementById(e.name).getParent().appendChild(new Element("input",{type:"hidden",name:e.name+"[crop]["+e.strImg+"]",value:e.param})))}));var o=e(i[0]).find("#"+n);if(o[0]){var a=null;a=/selected-checkbox-/.test(e(o[0]).attr("class"))?new Element("input",{type:"checkbox",value:s,hidden:!0,style:"display: none",checked:"checked",name:n+"[]"}):new Element("option",{value:s,selected:"selected"}),o[0].appendChild(a),i.css("display","none"),i.appendTo(e(document).find("body")),i.submit()}})):alert("Error(1): Não foi possível atualizar o registro!")})):e.ajax({type:"POST",url:"index.php?option=com_fabrik&view=form&Itemid=135&formid="+t.options.listId+"&rowid="+l+"&listid="+t.options.listId,context:document.body}).done((function(n){var o=e(n).find(".fabrikForm");o[0]?e.ajax({url:t.options.url+"&method=fileuploadelements_options",data:{value:parseInt(l)}}).done((function(n){JSON.parse(n).forEach((e=>{o[0].getElementById(e.name)&&(o[0].getElementById(e.name).getParent().appendChild(new Element("input",{type:"hidden",name:e.name+"[id]["+e.strImg+"]",value:e.value})),o[0].getElementById(e.name).getParent().appendChild(new Element("input",{type:"hidden",name:e.name+"[crop]["+e.strImg+"]",value:e.param})))}));var i=e(o[0]).find(".selected-checkbox-"+t.options.singleName);if(i[0])if(e(i[0]).find(">:first-child")[0]){e(i[0]).find(">:first-child")[0].remove();var a=new Element("input",{type:"checkbox",value:s,hidden:!0,style:"display: none",checked:"checked",name:t.options.fullName+"[]"});i[0].appendChild(a),o.css("display","none"),o.appendTo(e(document).find("body")),o.submit()}else{a=new Element("input",{type:"checkbox",value:s,hidden:!0,style:"display: none",checked:"checked",name:t.options.fullName+"[]"});i[0].appendChild(a),o.css("display","none"),o.appendTo(e(document).find("body")),o.submit()}})):alert("Error(1): Não foi possível atualizar o registro!")}))}))}else alert("Error(3): Não foi possível atualizar o registro!")}else alert("Error(4): Desculpe, mas você não está autorizado a editar este registro.");else if(t.options.userGroups.find(o)&&(a=document.elementFromPoint(i.clientX,i.clientY))&&(r=a.closest("a"))&&r.getAttribute("data-rowid")){l=r.getAttribute("data-rowid"),s=n.value?n.value:n.id;e.ajax({type:"POST",url:"index.php?option=com_fabrik&view=form&Itemid=135&formid="+t.options.listId+"&rowid="+l+"&listid="+t.options.listId,context:document.body}).done((function(n){var o=e(n).find(".fabrikForm");o[0]?e.ajax({url:t.options.url+"&method=fileuploadelements_options",data:{value:parseInt(l)}}).done((function(n){JSON.parse(n).forEach((e=>{o[0].getElementById(e.name)&&(o[0].getElementById(e.name).getParent().appendChild(new Element("input",{type:"hidden",name:e.name+"[id]["+e.strImg+"]",value:e.value})),o[0].getElementById(e.name).getParent().appendChild(new Element("input",{type:"hidden",name:e.name+"[crop]["+e.strImg+"]",value:e.param})))}));var i=e(o[0]).find("#"+t.options.fullName);if(i[0]){var a=null;a=/selected-checkbox-/.test(e(i[0]).attr("class"))?new Element("input",{type:"checkbox",value:s,hidden:!0,style:"display: none",checked:"checked",name:t.options.fullName+"[]"}):new Element("option",{value:s,selected:"selected"}),i[0].appendChild(a),o.css("display","none"),o.appendTo(e(document).find("body")),o.submit()}else if((i=e(o[0]).find(".selected-checkbox-"+t.options.singleName))[0])if(e(i[0]).find(">:first-child")[0]){e(i[0]).find(">:first-child")[0].remove();var r=new Element("input",{type:"checkbox",value:s,hidden:!0,style:"display: none",checked:"checked",name:t.options.fullName+"[]"});i[0].appendChild(r),o.css("display","none"),o.appendTo(e(document).find("body")),o.submit()}else{r=new Element("input",{type:"checkbox",value:s,hidden:!0,style:"display: none",checked:"checked",name:t.options.fullName+"[]"});i[0].appendChild(r),o.css("display","none"),o.appendTo(e(document).find("body")),o.submit()}})):alert("Error(8): Não foi possível atualizar o registro!")}))}}else alert("Error(6): O drag-and-drop não está ativado para este filtro")},onCanMoveTo:function(e,t,n){t.is_menu},onCreateLi:function(e,t,n){void 0!==e.counter&&0!=e.counter&&(t.find(".jqtree-title")[0].innerHTML=t.find(".jqtree-title")[0].innerHTML+" ("+e.counter+") ")}}),1==t.options.buildMethod&&"datetree"!=t.options.typeFilter?t.buildEventTreeRecursive():t.addEventsInTree()},buildTree:function(){let t=this;this.ajax=new Request({url:this.options.url+"&method=treeview_options",data:{value:""},onSuccess:function(n){let o=this.buildResultTree(JSON.parse(n));o=1==t.options.sortedBy?o.sort(t.compareValues("counter","desc")):o.sort(t.compareValues("counter","asc")),e(this.options.labeldivTree).tree({data:o,selectable:!1,onCreateLi:function(e,t,n){e.counter&&t.find(".jqtree-title").after("&nbsp<span>("+e.counter+")</span>")}}),t.addEventsInTree()}.bind(this),onFailure:function(e){this.ajax=null,fconsole("PITT treeview autocomplete: Ajax failure: Code "+e.status+": "+e.statusText)}.bind(this)}).send()},buildResultTree:function(e){return e.forEach((e=>{e.children&&(e.children=[{}]),JSON.parse(this.options.count).forEach((t=>{t.value!=e.id||(e.counter=t.counter)}))})),e},compareValues:function(e,t="asc"){return function(n,o){if(!n.hasOwnProperty(e)||!o.hasOwnProperty(e))return 0;const i="string"==typeof n[e]?parseInt(n[e]):n[e],a="string"==typeof o[e]?parseInt(o[e]):o[e];let r=0;return i>a?r=1:i<a&&(r=-1),"desc"==t?-1*r:r}},removeTag:function(t){this.options.labeldivSelected.parentNode.removeChild(t.container),this.options.labeldivSelected.removeChild(t.input);var n=e(".filteredTags")[0];n&&e(n).find("span[tag-value='"+t.input.value+"']")[0]&&e(n).find("span[tag-value='"+t.input.value+"']")[0].remove(),Fabrik.fireEvent("fabrik.list.dofilter",[this])},existsTag:function(e){if(this.options.labeldivSelected.hasChildNodes())for(let t of this.options.labeldivSelected.childNodes)if(t.value==e)return!0;return!1},existsTagDateTree:function(){if(this.options.labeldivSelected.childNodes.length>1&&"datetree"==this.options.typeFilter){let e=this.options.labeldivSelected.previousElementSibling;return null!=e&&(e.style.background="#ff000021",setTimeout((function(){e.style.removeProperty("background")}),500)),!0}return!1},addTag:function(t,n){let o=this,i=null;n=n.toString();"datetree"==o.options.typeFilter&&(i=n.split(" - "));let a={id:n,text:t,container:new Element("div.tag-container"),content:new Element("span.tag-content"),input:new Element("input.fabrikinput.fabrik_filter",{"tree-input-filter":o.options.fullName,"data-filter-name":o.options.fullName,type:"checkbox",styles:{display:"none"},name:this.options.nameElement+"["+Math.floor(10*Math.random())+"]",checked:!0}),closeButton:new Element("span.tag-close-button")};(a.input.value=null!==i?i[0]:n,a.content.textContent="treedate"==o.options.typeFilter&&isNaN(t.split(" - ")[0])?t+"/"+n.substr(0,4):t,a.closeButton.textContent="x",o.options.labeldivSelected.appendChild(a.input),"datetree"!=o.options.typeFilter)?(a.container.appendChild(a.content),a.container.appendChild(a.closeButton),a.closeButton.addEventListener("click",(function(){let e=2==t.split(" - ").length?t.split(" - "):n.split("/");if("datetree"==o.options.typeFilter){document.querySelectorAll("input[tree-input-filter="+o.options.fullName+"][value^='"+e[0]+"']:not([value='"+n+"'])").forEach((e=>{e.remove()}))}o.removeTag(a)}),!1),e(".filteredTags")[0]&&e(".filteredTags").append('<span tag-value="'+n+'" class="tagSearched">'+t+"</span>")):(document.getElementsByClassName,a.container=new Element("div",{styles:{display:"none"}}));o.options.labeldivSelected.parentNode.insertBefore(a.container,o.options.labeldivSelected),null!=i?(o.options.typeFilter="treedate",o.addTag(t,i[1])):"treedate"==o.options.typeFilter&&(o.options.typeFilter="datetree"),Fabrik.fireEvent("fabrik.list.dofilter",[this])},addEventsInTree:function(){let t=this;e(t.options.labeldivTree).on("tree.open",(function(n){let o=parseInt(n.node.value)?parseInt(n.node.value):parseInt(n.node.id);"datetree"==t.options.typeFilter&&(o=n.node.name),o?this.ajax=new Request({url:t.options.url+"&method=treeview_options",data:{value:o},onSuccess:function(o){e(t.options.labeldivTree).tree("loadData",JSON.parse(o),n.node)}.bind(this),onFailure:function(e){this.ajax=null,fconsole("Fabrik autocomplete: Ajax failure: Code "+e.status+": "+e.statusText),n.node.children=[]}.bind(this)}).send():(fconsole("Fabrik autocomplete: Ajax failure: Code "+xhr.status+": "+xhr.statusText),n.node.children=!1)})),e(t.options.labeldivTree).on("tree.click",(function(e){var n=e.node,o=n.value?n.value:n.id;t.existsTagDateTree()||t.existsTag(o)||t.addTag(n.name,o,!0)}))}})}));